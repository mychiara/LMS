<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS Gamifikasi Mahasiswa</title>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- SheetJS for Excel Upload -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #00796B; /* Teal Green - Lebih cerah */
            --secondary-color: #F9A825; /* Amber Yellow - Aksen */
            --light-bg: #fdfdff;
            --card-border-radius: 1rem;
            --card-shadow: 0 4px 25px rgba(0, 0, 0, 0.08);
            --gradient-primary: linear-gradient(45deg, #00796B, #004D40);
            --gradient-secondary: linear-gradient(45deg, #F9A825, #FF8F00);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-bg);
            background-image: linear-gradient(to right top, #f3f4f6, #f7f7f9, #fbfbfb, #fefefe, #ffffff);
            color: #444;
        }

        /* Sembunyikan semua view secara default */
        .view {
            display: none;
        }

        /* Custom Styles */
        .card {
            border: 1px solid #eef;
            border-radius: var(--card-border-radius);
            box-shadow: var(--card-shadow);
            background-color: #ffffff;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }

        .btn {
            border-radius: 0.5rem;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary {
            background-image: var(--gradient-primary);
            color: white;
        }
        .btn-primary:hover {
            box-shadow: 0 5px 15px rgba(0, 121, 107, 0.4);
            transform: translateY(-2px);
            color: white;
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        .btn-success:hover {
            background-color: #F57F17;
            border-color: #F57F17;
            box-shadow: 0 5px 15px rgba(249, 168, 37, 0.4);
            transform: translateY(-2px);
        }

        .navbar-brand { font-weight: 700; }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Login & Leaderboard Specific */
        #login-view .brand-logo {
            font-size: 5rem;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #login-view h1.display-5 {
            font-weight: 700;
        }
        
        /* [BARU] Notifikasi Info Terbaru */
        .updates-card .list-group-item {
            border: none;
            border-bottom: 1px solid #f0f0f0;
            padding: 1rem;
        }
        .updates-card .list-group-item:last-child {
            border-bottom: none;
        }
        .updates-card .list-group-item i {
            font-size: 1.2rem;
        }


        #leaderboardList .list-group-item {
            border: none;
            padding: 1rem;
            border-left: 5px solid transparent;
        }
        #leaderboardList .list-group-item:nth-child(1) { border-left-color: #FFC107; background-color: #fffaf0; } /* Gold */
        #leaderboardList .list-group-item:nth-child(2) { border-left-color: #C0C0C0; background-color: #f8f9fa; } /* Silver */
        #leaderboardList .list-group-item:nth-child(3) { border-left-color: #CD7F32; background-color: #fdf5e6; } /* Bronze */

        /* Admin Dashboard Specific */
        .stat-card {
            border-left: 5px solid var(--primary-color);
        }
        .stat-card .icon-circle {
            width: 60px; height: 60px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 1.8rem; margin-right: 1rem;
        }
        .stat-card .stat-text h3 { font-size: 2rem; color: #333; }
        .stat-card .stat-text p { margin-bottom: 0; color: #6c757d; font-size: 0.9rem; }
        .icon-primary { background-color: rgba(0, 121, 107, 0.1); color: var(--primary-color); }
        .icon-success { background-color: rgba(249, 168, 37, 0.1); color: var(--secondary-color); }
        .icon-info { background-color: rgba(3, 169, 244, 0.1); color: #03A9F4; }
        .icon-warning { background-color: rgba(255, 87, 34, 0.1); color: #FF5722; }

        .excel-upload-box {
            background-color: #f8f9fa; border: 2px dashed #dee2e6;
            padding: 1.5rem; border-radius: var(--card-border-radius); text-align: center;
        }

        /* Kuis View */
        .form-check-input:checked {
            background-color: var(--primary-color); border-color: var(--primary-color);
        }
        
        /* Modal Video Embed */
        .video-responsive {
            overflow: hidden;
            padding-bottom: 56.25%;
            position: relative;
            height: 0;
            border-radius: 0.75rem;
        }
        .video-responsive iframe {
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            position: absolute;
        }
    </style>
</head>
<body>

<main class="container my-4 my-lg-5">

    <!-- =================================================================== -->
    <!-- VIEW 1: HALAMAN LOGIN, LEADERBOARD & NOTIFIKASI (HALAMAN UTAMA)     -->
    <!-- =================================================================== -->
    <div id="login-view" class="view">
        <div class="text-center mb-5">
            <div class="brand-logo"><i class="bi bi-mortarboard-fill"></i></div>
            <h1 class="display-5">Selamat Datang di LMS Gamifikasi</h1>
            <p class="lead text-muted">Platform belajar interaktif Poltekkes.</p>
        </div>
        <div class="row justify-content-center g-4 g-lg-5">
            <!-- [BARU] Kolom Notifikasi Info Terbaru -->
            <div class="col-lg-4">
                 <div class="card updates-card h-100">
                    <div class="card-body">
                        <h4 class="card-title text-center mb-4"><i class="bi bi-bell-fill text-primary"></i> Info Terbaru</h4>
                        <div id="latestUpdatesContainer" class="list-group list-group-flush">
                            <div class="text-center p-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Memuat...</span>
                                </div>
                                <p class="mt-2 text-muted">Memuat info terbaru...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Kolom Papan Peringkat -->
            <div class="col-lg-4">
                 <div class="card h-100">
                    <div class="card-body">
                        <h4 class="card-title text-center mb-4"><i class="bi bi-trophy-fill text-warning"></i> Papan Peringkat</h4>
                        <ol id="leaderboardList" class="list-group list-group-numbered">
                            <li class="list-group-item">Memuat data peringkat...</li>
                        </ol>
                    </div>
                </div>
            </div>
            <!-- Kolom Login -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body p-4 p-lg-5 d-flex flex-column justify-content-center">
                        <h3 class="card-title text-center mb-4">Login Pengguna</h3>
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control form-control-lg" id="email" placeholder="contoh@email.com" required>
                            </div>
                            <div class="mb-4">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control form-control-lg" id="password" placeholder="******" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">
                                <i class="bi bi-box-arrow-in-right"></i> Login
                            </button>
                            <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- =================================================================== -->
    <!-- VIEW 2: DASHBOARD ADMIN                                             -->
    <!-- =================================================================== -->
    <div id="admin-view" class="view">
        <nav class="navbar navbar-expand-lg navbar-light bg-white rounded-3 mb-4 p-3 shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><i class="bi bi-shield-lock-fill"></i> Panel Admin</a>
                <button id="logoutButtonAdmin" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </nav>
        
        <h4><i class="bi bi-graph-up-arrow"></i> Ringkasan Sistem</h4>
        <div class="row mb-4 g-4">
            <div class="col-md-6 col-lg-3">
                <div class="card stat-card">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-circle icon-primary"><i class="bi bi-people-fill"></i></div>
                        <div class="stat-text"><h3 id="totalMahasiswaStat">0</h3><p>Total Mahasiswa</p></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                 <div class="card stat-card" style="border-left-color: var(--secondary-color);">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-circle icon-success"><i class="bi bi-person-video3"></i></div>
                        <div class="stat-text"><h3 id="totalDosenStat">0</h3><p>Total Dosen</p></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                 <div class="card stat-card" style="border-left-color: #03A9F4;">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-circle icon-info"><i class="bi bi-book-fill"></i></div>
                        <div class="stat-text"><h3 id="totalMateriStat">0</h3><p>Total Materi</p></div>
                    </div>
                </div>
            </div>
             <div class="col-md-6 col-lg-3">
                 <div class="card stat-card" style="border-left-color: #FF5722;">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-circle icon-warning"><i class="bi bi-patch-question-fill"></i></div>
                        <div class="stat-text"><h3 id="totalKuisStat">0</h3><p>Total Kuis</p></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3"><i class="bi bi-person-gear"></i> Manajemen Pengguna</h5>
                        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#userModal" onclick="prepareUserModal('new')">
                            <i class="bi bi-plus-circle"></i> Tambah Pengguna Manual
                        </button>
                        
                        <div class="excel-upload-box mb-3">
                            <p class="mb-2 fw-bold">Atau, import pengguna dari file Excel:</p>
                            <div class="input-group">
                                 <input type="file" class="form-control" id="userExcelFile" accept=".xlsx, .xls, .csv">
                                 <button class="btn btn-outline-success" type="button" id="importUsersBtn"><i class="bi bi-upload"></i> Import</button>
                            </div>
                             <small class="form-text text-muted mt-2 d-block">
                                Pastikan format sesuai. <a href="#" id="downloadUserTemplateLink" class="fw-bold">Download Template</a>.
                            </small>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr><th>Nama</th><th>Email</th><th>Role</th><th>NIM/NIDN</th><th>Aksi</th></tr>
                                </thead>
                                <tbody id="userTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                 <div class="card h-100">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3"><i class="bi bi-activity"></i> Aktivitas Pengerjaan Kuis Terbaru</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead><tr><th>Mahasiswa</th><th>Kuis</th><th>Skor</th></tr></thead>
                                <tbody id="recentSubmissionsTable">
                                    <tr><td colspan="3">Memuat aktivitas...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- =================================================================== -->
    <!-- VIEW 3: DASHBOARD DOSEN                                             -->
    <!-- =================================================================== -->
    <div id="dosen-view" class="view">
        <nav class="navbar navbar-light bg-white rounded-3 mb-4 p-3 shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><i class="bi bi-person-workspace"></i> Panel Dosen</a>
                <span class="navbar-text text-muted me-auto ms-4" id="dosenWelcome"></span>
                <button id="logoutButtonDosen" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </nav>
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4"><i class="bi bi-journal-text text-success"></i> Manajemen Materi & Video</h4>
                        <button class="btn btn-success w-100 mb-3" data-bs-toggle="modal" data-bs-target="#materiModal">
                            <i class="bi bi-file-earmark-plus"></i> Tambah Materi / Video Baru
                        </button>
                        <div id="materiListDosen" class="list-group"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4"><i class="bi bi-controller text-primary"></i> Manajemen Kuis</h4>
                        <button class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#kuisModal" onclick="prepareKuisModal()">
                           <i class="bi bi-pencil-square"></i> Buat Kuis Manual
                        </button>
                        <div class="excel-upload-box">
                            <p class="mb-2">Atau, upload soal dari file Excel:</p>
                            <div class="input-group">
                                 <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls">
                                 <button class="btn btn-outline-primary" type="button" id="uploadExcelBtn"><i class="bi bi-upload"></i> Upload</button>
                            </div>
                             <small class="form-text text-muted mt-2 d-block">
                                Pastikan format sesuai. <a href="#" id="downloadTemplateLink" class="fw-bold">Download Template</a>.
                            </small>
                        </div>
                        <hr>
                        <h6>Daftar Kuis Dibuat:</h6>
                        <div id="kuisListDosen" class="list-group mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4"><i class="bi bi-card-checklist"></i> Riwayat Pengerjaan Kuis oleh Mahasiswa</h4>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr><th>Nama Mahasiswa</th><th>Judul Kuis</th><th>Skor</th><th>Tanggal</th></tr>
                                </thead>
                                <tbody id="dosenKuisHistoryList">
                                    <tr><td colspan="4" class="text-center text-muted">Memuat riwayat...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- =================================================================== -->
    <!-- VIEW 4: DASHBOARD MAHASISWA                                         -->
    <!-- =================================================================== -->
    <div id="mahasiswa-view" class="view">
        <nav class="navbar navbar-light bg-white rounded-3 mb-4 p-3 shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><i class="bi bi-easel2-fill"></i> Dashboard Mahasiswa</a>
                 <span class="navbar-text text-primary me-auto ms-4" id="mahasiswaWelcome"></span>
                <button id="logoutButtonMahasiswa" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </nav>
         <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4">ðŸ“š Materi & Video Perkuliahan</h4>
                        <div id="materiListMahasiswa" class="list-group"></div>
                    </div>
                </div>
            </div>
             <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4">ðŸš€ Kuis & Tantangan</h4>
                        <div id="kuisListMahasiswa" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4"><i class="bi bi-clock-history"></i> Riwayat Pengerjaan Kuis Kamu</h4>
                        <div id="mahasiswaKuisHistoryList" class="list-group">
                            <p class="text-center text-muted">Memuat riwayat...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <!-- =================================================================== -->
    <!-- VIEW 5: HALAMAN MENGERJAKAN KUIS                                    -->
    <!-- =================================================================== -->
    <div id="kuis-view" class="view">
        <div class="card shadow-sm mb-4">
            <div class="card-body d-flex justify-content-between align-items-center p-3">
                 <button class="btn btn-outline-secondary" onclick="showView('mahasiswa-view')"><i class="bi bi-arrow-left"></i> Kembali</button>
                 <h3 id="kuisTitle" class="mb-0"></h3>
                 <span class="badge bg-primary p-2 fs-6">Semangat!</span>
            </div>
        </div>
        <div id="kuisQuestionContainer"></div>
        <button class="btn btn-primary btn-lg w-100 mt-4" id="submitKuisBtn"><i class="bi bi-check2-circle"></i> Selesai & Kumpulkan Jawaban</button>
    </div>

</main> <!-- End .container -->


<!-- =================================================================== -->
<!-- MODALS (Jendela Pop-up)                                             -->
<!-- =================================================================== -->

<!-- Modal User (Admin) -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: var(--card-border-radius);">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Tambah Pengguna</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label class="form-label">Nama Lengkap</label>
                        <input type="text" class="form-control" id="userName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="userPassword" placeholder="Minimal 6 karakter">
                        <small class="form-text text-muted">Saat mengedit, kosongkan jika tidak ingin mengubah password.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">NIM / NIDN</label>
                        <input type="text" class="form-control" id="userNim" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="userRole">
                            <option value="mahasiswa">Mahasiswa</option>
                            <option value="dosen">Dosen</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100"><i class="bi bi-save"></i> Simpan</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- [DIUBAH] Modal Materi (Dosen) - Tambah Input Link YouTube -->
<div class="modal fade" id="materiModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border-radius: var(--card-border-radius);">
            <div class="modal-header">
                <h5 class="modal-title">Tambah/Edit Materi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="materiForm">
                    <input type="hidden" id="materiId">
                    <div class="mb-3">
                        <label class="form-label">Judul Materi</label>
                        <input type="text" id="materiJudul" class="form-control" required>
                    </div>
                    <!-- [BARU] Input Link YouTube -->
                    <div class="mb-3">
                        <label class="form-label">Link Video YouTube (Opsional)</label>
                        <input type="url" id="materiYoutubeLink" class="form-control" placeholder="Contoh: https://www.youtube.com/watch?v=xxxxxxxxxxx">
                        <small class="form-text text-muted">Sematkan video pembelajaran dari YouTube.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Isi Materi (Teks)</label>
                        <textarea id="materiIsi" class="form-control" rows="8" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Simpan Materi</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Kuis (Dosen) -->
<div class="modal fade" id="kuisModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="border-radius: var(--card-border-radius);">
            <div class="modal-header">
                <h5 class="modal-title">Buat Kuis Baru</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="kuisForm">
                    <input type="hidden" id="kuisId">
                    <div class="mb-3">
                        <label class="form-label">Judul Kuis</label>
                        <input type="text" id="kuisJudul" class="form-control" required>
                    </div>
                    <hr>
                    <div id="questionsContainer"></div>
                    <button type="button" class="btn btn-outline-success mt-2" onclick="addQuestionField()">
                        <i class="bi bi-plus-lg"></i> Tambah Pertanyaan
                    </button>
                    <hr>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Simpan Kuis</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- [DIUBAH] Modal Baca Materi (Mahasiswa) - Tambah Container Video -->
<div class="modal fade" id="bacaMateriModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content" style="border-radius: var(--card-border-radius);">
            <div class="modal-header">
                <h5 class="modal-title" id="bacaMateriJudul"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- [BARU] Container untuk video YouTube -->
                <div id="bacaMateriVideoContainer" class="mb-4"></div>
                <div id="bacaMateriIsi" style="white-space: pre-wrap;"></div>
            </div>
        </div>
    </div>
</div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
    // Import fungsi yang dibutuhkan dari Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { 
        getAuth, onAuthStateChanged, signInWithEmailAndPassword,
        createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { 
        getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc,
        updateDoc, deleteDoc, query, where, orderBy, limit, increment, Timestamp
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ===================================================================
    // KONFIGURASI FIREBASE                                              
    // ===================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyBRESh5Mbo15ttJzBeBokgB6qz4zSemHuw",
      authDomain: "lisa-levesquerez204.firebaseapp.com",
      databaseURL: "https://lisa-levesquerez204.firebaseio.com",
      projectId: "lisa-levesquerez204",
      storageBucket: "lisa-levesquerez204.firebasestorage.app",
      messagingSenderId: "320775541227",
      appId: "1:320775541227:web:041c60b324aee5044249ae"
    };

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===================================================================
    // GLOBAL VARIABLES & UTILITY FUNCTIONS                              
    // ===================================================================
    let currentUserData = null;
    const allViews = document.querySelectorAll('.view');
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));
    const materiModal = new bootstrap.Modal(document.getElementById('materiModal'));
    const kuisModal = new bootstrap.Modal(document.getElementById('kuisModal'));
    const bacaMateriModal = new bootstrap.Modal(document.getElementById('bacaMateriModal'));

    function showView(viewId) {
        allViews.forEach(view => { view.style.display = 'none'; });
        document.getElementById(viewId).style.display = 'block';
    }
    
    // ===================================================================
    // AUTHENTICATION & PAGE ROUTING LOGIC                               
    // ===================================================================
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                currentUserData = { uid: user.uid, ...userDoc.data() };
                switch (currentUserData.role) {
                    case 'admin':
                        showView('admin-view'); loadAdminDashboardStats(); loadUsers();
                        break;
                    case 'dosen':
                        showView('dosen-view');
                        document.getElementById('dosenWelcome').innerText = `Selamat datang, ${currentUserData.nama}`;
                        loadDosenContent();
                        break;
                    case 'mahasiswa':
                        showView('mahasiswa-view');
                        document.getElementById('mahasiswaWelcome').innerHTML = `<i class="bi bi-gem"></i> Poin Kamu: <strong>${currentUserData.totalSkor || 0}</strong>`;
                        loadMahasiswaContent();
                        break;
                    default: showView('login-view');
                }
            } else {
                console.error("User document not found for UID:", user.uid);
                await signOut(auth);
            }
        } else {
            currentUserData = null;
            showView('login-view');
            loadLeaderboard();
            loadLatestUpdates(); // [BARU] Muat notifikasi di halaman utama
        }
    });

    // Handle Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const loginError = document.getElementById('loginError');
        const loginButton = e.target.querySelector('button[type="submit"]');
        loginButton.disabled = true;
        loginButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Loading...`;
        try {
            await signInWithEmailAndPassword(auth, email, password);
            loginError.classList.add('d-none');
        } catch (error) {
            loginError.textContent = "Email atau password salah!";
            loginError.classList.remove('d-none');
        } finally {
            loginButton.disabled = false;
            loginButton.innerHTML = `<i class="bi bi-box-arrow-in-right"></i> Login`;
        }
    });

    // Handle Logout
    document.querySelectorAll('[id^="logoutButton"]').forEach(btn => {
        btn.addEventListener('click', () => signOut(auth));
    });

    // ===================================================================
    // [BARU] FUNGSI UNTUK PANEL NOTIFIKASI DI HALAMAN UTAMA             
    // ===================================================================
    async function loadLatestUpdates() {
        const container = document.getElementById('latestUpdatesContainer');
        container.innerHTML = ''; // Kosongkan dulu
        let updatesHTML = '';
        let updatesFound = false;

        try {
            // 1. Get Latest Material
            const materiQuery = query(collection(db, "materi"), orderBy("createdAt", "desc"), limit(1));
            const materiSnapshot = await getDocs(materiQuery);
            if (!materiSnapshot.empty) {
                updatesFound = true;
                const materi = materiSnapshot.docs[0].data();
                updatesHTML += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="bi bi-journal-text text-success me-2"></i> Materi Baru</h6>
                        </div>
                        <p class="mb-1 small fw-bold text-dark">${materi.judul}</p>
                        <small class="text-muted">Oleh: ${materi.dosenNama}</small>
                    </div>`;
            }

            // 2. Get Latest Quiz
            const kuisQuery = query(collection(db, "kuis"), orderBy("createdAt", "desc"), limit(1));
            const kuisSnapshot = await getDocs(kuisQuery);
            if (!kuisSnapshot.empty) {
                updatesFound = true;
                const kuis = kuisSnapshot.docs[0].data();
                updatesHTML += `
                     <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="bi bi-controller text-primary me-2"></i> Kuis Baru!</h6>
                        </div>
                        <p class="mb-1 small fw-bold text-dark">${kuis.judul}</p>
                        <small class="text-muted">Oleh: ${kuis.dosenNama}</small>
                    </div>`;
            }

            // 3. Get Latest Video (Materi dengan link YouTube)
            const videoQuery = query(collection(db, "materi"), where("youtubeLink", ">", ""), orderBy("youtubeLink"), orderBy("createdAt", "desc"), limit(1));
            const videoSnapshot = await getDocs(videoQuery);
             if (!videoSnapshot.empty) {
                updatesFound = true;
                const video = videoSnapshot.docs[0].data();
                updatesHTML += `
                     <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1"><i class="bi bi-youtube text-danger me-2"></i> Video Baru</h6>
                        </div>
                        <p class="mb-1 small fw-bold text-dark">${video.judul}</p>
                        <small class="text-muted">Oleh: ${video.dosenNama}</small>
                    </div>`;
            }
            
            if (!updatesFound) {
                container.innerHTML = '<p class="text-center text-muted p-4">Belum ada info terbaru saat ini.</p>';
            } else {
                container.innerHTML = updatesHTML;
            }

        } catch (error) {
            console.error("Error loading latest updates:", error);
            container.innerHTML = '<p class="text-center text-danger p-4">Gagal memuat info terbaru.</p>';
        }
    }


    // ===================================================================
    // LEADERBOARD LOGIC (ON LOGIN PAGE)                                 
    // ===================================================================
    async function loadLeaderboard() {
        const leaderboardList = document.getElementById('leaderboardList');
        try {
            const q = query(collection(db, "users"), where("role", "==", "mahasiswa"), orderBy("totalSkor", "desc"), limit(5));
            const querySnapshot = await getDocs(q);
            leaderboardList.innerHTML = '';
            if (querySnapshot.empty) {
                leaderboardList.innerHTML = '<li class="list-group-item text-muted">Belum ada data peringkat.</li>';
                return;
            }
            let rank = 1;
            querySnapshot.forEach(doc => {
                const user = doc.data();
                let medalIcon = '';
                if(rank === 1) medalIcon = '<i class="bi bi-trophy-fill text-warning me-2"></i>';
                else if (rank === 2) medalIcon = '<i class="bi bi-trophy-fill text-secondary me-2" style="color: #adb5bd !important;"></i>';
                else if (rank === 3) medalIcon = '<i class="bi bi-trophy-fill text-danger me-2" style="color: #cd7f32 !important;"></i>';

                leaderboardList.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div> ${medalIcon} <span class="fw-bold">${user.nama}</span> </div>
                        <span class="badge bg-primary rounded-pill">${user.totalSkor || 0} Poin</span>
                    </li>`;
                rank++;
            });
        } catch (error) {
            console.error("Error loading leaderboard: ", error);
            leaderboardList.innerHTML = '<li class="list-group-item text-danger">Gagal memuat data.</li>';
        }
    }

    // ===================================================================
    // DOSEN DASHBOARD LOGIC                                             
    // ===================================================================
    async function loadDosenContent() {
        loadMateriForDosen();
        loadKuisForDosen();
        loadDosenKuisHistory();
    }
    
    // -- [DIUBAH] Materi Logic (Menyimpan Link YouTube) --
    document.getElementById('materiForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            judul: document.getElementById('materiJudul').value,
            isi: document.getElementById('materiIsi').value,
            youtubeLink: document.getElementById('materiYoutubeLink').value.trim(), // [BARU]
            dosenId: currentUserData.uid,
            dosenNama: currentUserData.nama,
            createdAt: Timestamp.now()
        };
        await addDoc(collection(db, "materi"), data);
        materiModal.hide();
        document.getElementById('materiForm').reset();
        loadMateriForDosen();
    });

    async function loadMateriForDosen() {
        const listContainer = document.getElementById('materiListDosen');
        listContainer.innerHTML = '<p class="text-center text-muted">Memuat materi...</p>';
        const q = query(collection(db, "materi"), where("dosenId", "==", currentUserData.uid), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        listContainer.innerHTML = '';
        if (snapshot.empty) {
            listContainer.innerHTML = '<p class="text-center text-muted">Anda belum menambahkan materi.</p>'; return;
        }
        snapshot.forEach(doc => {
            const materi = doc.data();
            const videoIcon = materi.youtubeLink ? '<i class="bi bi-youtube text-danger me-2"></i>' : '<i class="bi bi-file-earmark-text me-2"></i>';
            listContainer.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${videoIcon}${materi.judul}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMateri('${doc.id}')"><i class="bi bi-trash"></i></button>
                </div>`;
        });
    }

    // ... (Fungsi deleteMateri, kuis, dll tetap sama) ...
    // ... Sisa fungsi ADMIN, DOSEN, dan MAHASISWA yang tidak berubah secara langsung ...
    // ... Saya akan menempelkan sisa JS lengkapnya di bawah ini agar tidak ada yang terlewat ...

    // ===================================================================
    // MAHASISWA DASHBOARD LOGIC                                         
    // ===================================================================
    async function loadMahasiswaContent() {
        loadMateriForMahasiswa();
        loadKuisForMahasiswa();
        loadMahasiswaKuisHistory();
    }

    async function loadMateriForMahasiswa() {
        const materiContainer = document.getElementById('materiListMahasiswa');
        materiContainer.innerHTML = '<p class="text-center text-muted">Memuat...</p>';
        const materiQuery = query(collection(db, "materi"), orderBy("createdAt", "desc"));
        const materiSnapshot = await getDocs(materiQuery);
        materiContainer.innerHTML = '';
        if (materiSnapshot.empty) materiContainer.innerHTML = '<p class="text-center text-muted">Belum ada materi.</p>';
        materiSnapshot.forEach(doc => {
            const materi = doc.data();
            const icon = materi.youtubeLink ? '<i class="bi bi-play-btn-fill text-danger"></i>' : 'ðŸ“š';
            materiContainer.innerHTML += `
                <button type="button" class="list-group-item list-group-item-action" onclick="bacaMateri('${doc.id}')">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <h6 class="mb-1 text-dark">${icon} ${materi.judul}</h6>
                    </div>
                    <small class="text-muted"><i class="bi bi-person-fill"></i> Oleh: ${materi.dosenNama}</small>
                </button>`;
        });
    }
    
    // -- [DIUBAH] Fungsi Baca Materi untuk Menampilkan Video --
    window.bacaMateri = async function(materiId) {
        const docRef = doc(db, "materi", materiId);
        const docSnap = await getDoc(docRef);
        const videoContainer = document.getElementById('bacaMateriVideoContainer');
        videoContainer.innerHTML = ''; // Reset container

        if (docSnap.exists()) {
            const materi = docSnap.data();
            document.getElementById('bacaMateriJudul').innerText = materi.judul;
            document.getElementById('bacaMateriIsi').innerText = materi.isi;

            // [BARU] Logika untuk embed video YouTube
            if (materi.youtubeLink) {
                try {
                    const url = new URL(materi.youtubeLink);
                    let videoId = url.searchParams.get("v"); // Untuk link format /watch?v=...
                    if (!videoId) { // Untuk link format youtu.be/...
                        videoId = url.pathname.substring(1);
                    }
                    if (videoId) {
                        videoContainer.innerHTML = `
                            <div class="video-responsive">
                                <iframe src="https://www.youtube.com/embed/${videoId}" 
                                title="YouTube video player" frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen></iframe>
                            </div>`;
                    }
                } catch (e) {
                    console.error("Invalid YouTube URL:", materi.youtubeLink);
                }
            }

            bacaMateriModal.show();
        }
    }

    // SISA KODE JS DARI FILE ASLI (yang tidak diubah)
    // Ini diperlukan agar semua fungsi tetap berjalan
    
    async function loadAdminDashboardStats() {
        const usersSnapshot = await getDocs(collection(db, "users"));
        let mahasiswaCount = 0, dosenCount = 0;
        usersSnapshot.forEach(doc => {
            if (doc.data().role === 'mahasiswa') mahasiswaCount++;
            if (doc.data().role === 'dosen') dosenCount++;
        });
        document.getElementById('totalMahasiswaStat').innerText = mahasiswaCount;
        document.getElementById('totalDosenStat').innerText = dosenCount;

        const materiSnapshot = await getDocs(collection(db, "materi"));
        const kuisSnapshot = await getDocs(collection(db, "kuis"));
        document.getElementById('totalMateriStat').innerText = materiSnapshot.size;
        document.getElementById('totalKuisStat').innerText = kuisSnapshot.size;

        const submissionsTable = document.getElementById('recentSubmissionsTable');
        const submissionsQuery = query(collection(db, "kuisSubmissions"), orderBy("timestamp", "desc"), limit(5));
        const submissionsSnapshot = await getDocs(submissionsQuery);
        submissionsTable.innerHTML = '';
        if (submissionsSnapshot.empty) {
            submissionsTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Belum ada aktivitas.</td></tr>';
            return;
        }
        submissionsSnapshot.forEach(async(submissionDoc) => {
            const sub = submissionDoc.data();
            const userDoc = await getDoc(doc(db, "users", sub.mahasiswaId));
            const mahasiswaNama = userDoc.exists() ? userDoc.data().nama : "Mahasiswa Dihapus";
            submissionsTable.innerHTML += `<tr><td>${mahasiswaNama}</td><td>${sub.kuisJudul}</td><td><span class="badge bg-info">${sub.skorPersen}%</span></td></tr>`;
        });
    }

    const userForm = document.getElementById('userForm');
    
    window.prepareUserModal = async function(mode, userId = null) {
        userForm.reset();
        const userModalLabel = document.getElementById('userModalLabel');
        const userEmailInput = document.getElementById('userEmail');
        const userPasswordInput = document.getElementById('userPassword');
        document.getElementById('userId').value = userId || '';

        if (mode === 'edit') {
            userModalLabel.innerText = 'Edit Pengguna';
            userEmailInput.disabled = true; 
            userPasswordInput.required = false;
            userPasswordInput.placeholder = "Kosongkan jika tidak ingin mengubah";

            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    document.getElementById('userName').value = data.nama;
                    userEmailInput.value = data.email;
                    document.getElementById('userNim').value = data.nim_nidn;
                    document.getElementById('userRole').value = data.role;
                    userModal.show();
                } else { alert('Data pengguna tidak ditemukan.'); }
            } catch (error) { alert('Gagal memuat data pengguna: ' + error.message); }
        } else {
            userModalLabel.innerText = 'Tambah Pengguna Baru';
            userEmailInput.disabled = false;
            userPasswordInput.required = true;
            userPasswordInput.placeholder = "Minimal 6 karakter";
        }
    }

    async function loadUsers() {
        const userTableBody = document.getElementById('userTableBody');
        userTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Memuat...</td></tr>';
        const q = query(collection(db, "users"), where("role", "!=", "admin"));
        const querySnapshot = await getDocs(q);
        userTableBody.innerHTML = '';
        querySnapshot.forEach((doc) => {
            const user = doc.data();
            userTableBody.innerHTML += `
                <tr>
                    <td><strong>${user.nama}</strong></td><td>${user.email}</td>
                    <td><span class="badge rounded-pill text-bg-${user.role === 'dosen' ? 'success' : 'info'}">${user.role}</span></td>
                    <td>${user.nim_nidn}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="prepareUserModal('edit', '${doc.id}')"><i class="bi bi-pencil-square"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${doc.id}', '${user.nama}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    userForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = document.getElementById('userId').value;
        const password = document.getElementById('userPassword').value;
        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;

        const userData = {
            nama: document.getElementById('userName').value,
            email: document.getElementById('userEmail').value,
            nim_nidn: document.getElementById('userNim').value,
            role: document.getElementById('userRole').value,
        };
        
        try {
            if (userId) { // Mode EDIT
                const userRef = doc(db, "users", userId);
                await updateDoc(userRef, {
                    nama: userData.nama, nim_nidn: userData.nim_nidn, role: userData.role,
                });
                alert('Data pengguna berhasil diperbarui!');
            } else { // Mode Tambah PENGGUNA BARU
                if (password.length < 6) throw new Error("Password minimal 6 karakter!");
                const userCredential = await createUserWithEmailAndPassword(auth, userData.email, password);
                const userPayload = { ...userData };
                if (userPayload.role === 'mahasiswa') userPayload.totalSkor = 0;
                await setDoc(doc(db, "users", userCredential.user.uid), userPayload);
                alert('Pengguna baru berhasil dibuat!');
            }
            userModal.hide(); loadUsers(); loadAdminDashboardStats();
        } catch (error) {
            alert('Gagal menyimpan pengguna: ' + error.message);
        } finally { submitButton.disabled = false; }
    });

    window.deleteUser = async function(userId, userName) {
        if (confirm(`Yakin ingin menghapus ${userName}?`)) {
            try {
                await deleteDoc(doc(db, "users", userId));
                alert('Pengguna berhasil dihapus.');
                loadUsers(); loadAdminDashboardStats();
            } catch (error) { alert('Gagal menghapus: ' + error.message); }
        }
    }

    document.getElementById('downloadUserTemplateLink').addEventListener('click', (e) => {
        e.preventDefault();
        const templateData = [
            ["nama", "email", "password", "nim_nidn", "role"],
            ["Budi Santoso", "budi.mhs@email.com", "password123", "2101001", "mahasiswa"],
            ["Dr. Ahmad Dahlan", "ahmad.dosen@email.com", "dosenaman", "9901001", "dosen"]
        ];
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Template Import Pengguna");
        XLSX.writeFile(wb, "Template_Import_Pengguna.xlsx");
    });

    document.getElementById('importUsersBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('userExcelFile');
        const file = fileInput.files[0];
        const btn = document.getElementById('importUsersBtn');
        if (!file) { alert('Silakan pilih file.'); return; }
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Mengimpor...`;
        const reader = new FileReader();
        reader.onload = async (e) => {
            let successCount = 0, failCount = 0, errorMessages = [];
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const usersToImport = XLSX.utils.sheet_to_json(worksheet);
                for (const user of usersToImport) {
                    const { nama, email, password, nim_nidn, role } = user;
                    if (!nama || !email || !password || !nim_nidn || !role || password.toString().length < 6 || !['mahasiswa', 'dosen'].includes(role.toString().toLowerCase())) {
                        failCount++;
                        errorMessages.push(`Baris untuk ${email || 'email kosong'} dilewati: data tidak valid.`);
                        continue;
                    }
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password.toString());
                        const userPayload = { nama, email, nim_nidn, role, totalSkor: role === 'mahasiswa' ? 0 : undefined };
                        await setDoc(doc(db, "users", userCredential.user.uid), userPayload);
                        successCount++;
                    } catch (error) {
                        failCount++;
                        errorMessages.push(`Gagal impor ${email}: ${error.code === 'auth/email-already-in-use' ? 'email sudah ada' : 'gagal'}`);
                    }
                }
                alert(`Impor selesai.\nBerhasil: ${successCount}\nGagal: ${failCount}\n\nDetail:\n${errorMessages.slice(0, 5).join('\n')}`);
                loadUsers(); loadAdminDashboardStats(); fileInput.value = '';
            } catch (error) {
                alert('Gagal memproses file: ' + error.message);
            } finally {
                btn.disabled = false; btn.innerHTML = `<i class="bi bi-upload"></i> Import`;
            }
        };
        reader.readAsArrayBuffer(file);
    });

    window.deleteMateri = async function(id) {
        if (confirm('Yakin ingin hapus materi ini?')) {
            await deleteDoc(doc(db, "materi", id));
            loadMateriForDosen();
        }
    }
    
    let questionCount = 0;
    
    window.addQuestionField = function() {
        questionCount++;
        const container = document.getElementById('questionsContainer');
        const questionDiv = document.createElement('div');
        questionDiv.className = 'card mb-3 bg-light';
        questionDiv.innerHTML = `<div class="card-body"><div class="d-flex justify-content-between"><h6>Pertanyaan ${questionCount}</h6><button type="button" class="btn-close" onclick="this.closest('.card').remove()"></button></div><textarea class="form-control mb-2" placeholder="Tulis pertanyaan di sini" required></textarea><div class="input-group mb-1"> <span class="input-group-text">A</span> <input type="text" class="form-control" placeholder="Pilihan A" required> </div><div class="input-group mb-1"> <span class="input-group-text">B</span> <input type="text" class="form-control" placeholder="Pilihan B" required> </div><div class="input-group mb-1"> <span class="input-group-text">C</span> <input type="text" class="form-control" placeholder="Pilihan C" required> </div><div class="input-group mb-2"> <span class="input-group-text">D</span> <input type="text" class="form-control" placeholder="Pilihan D" required> </div><select class="form-select form-select-sm" required><option value="" selected disabled>-- Pilih Jawaban Benar --</option> <option value="0">Jawaban A</option> <option value="1">Jawaban B</option> <option value="2">Jawaban C</option> <option value="3">Jawaban D</option></select></div>`;
        container.appendChild(questionDiv);
    }

    window.prepareKuisModal = function() {
        document.getElementById('kuisForm').reset();
        document.getElementById('questionsContainer').innerHTML = '';
        questionCount = 0; addQuestionField();
    }
    
    document.getElementById('kuisForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const questions = [];
        document.getElementById('questionsContainer').querySelectorAll('.card').forEach(qEl => {
            const questionText = qEl.querySelector('textarea').value;
            const options = Array.from(qEl.querySelectorAll('input[type="text"]')).map(input => input.value);
            const correctIndex = qEl.querySelector('select').value;
            if(questionText && options.every(o => o) && correctIndex) {
                 questions.push({ questionText, options, correctIndex });
            }
        });
        if (questions.length === 0) { alert("Buat setidaknya satu pertanyaan valid."); return; }
        const kuisData = {
            judul: document.getElementById('kuisJudul').value,
            dosenId: currentUserData.uid,
            dosenNama: currentUserData.nama,
            questions: questions,
            createdAt: Timestamp.now()
        };
        try {
            await addDoc(collection(db, "kuis"), kuisData);
            kuisModal.hide(); loadKuisForDosen();
        } catch(error) { alert('Gagal menyimpan kuis: ' + error.message); }
    });
    
    async function loadKuisForDosen() {
        const listContainer = document.getElementById('kuisListDosen');
        listContainer.innerHTML = '<p class="text-center text-muted">Memuat kuis...</p>';
        const q = query(collection(db, "kuis"), where("dosenId", "==", currentUserData.uid), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        listContainer.innerHTML = '';
        if (snapshot.empty) { listContainer.innerHTML = '<p class="text-center text-muted">Anda belum membuat kuis.</p>'; return; }
        snapshot.forEach(doc => {
            const kuis = doc.data();
            listContainer.innerHTML += `<div class="list-group-item d-flex justify-content-between align-items-center"><span><i class="bi bi-patch-question me-2"></i> ${kuis.judul} (${kuis.questions.length} soal)</span><button class="btn btn-sm btn-outline-danger" onclick="deleteKuis('${doc.id}')"><i class="bi bi-trash"></i></button></div>`;
        });
    }

    window.deleteKuis = async function(id) {
         if (confirm('Yakin ingin hapus kuis ini?')) {
            await deleteDoc(doc(db, "kuis", id));
            loadKuisForDosen();
        }
    }

    document.getElementById('uploadExcelBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('excelFile');
        if (fileInput.files.length === 0) { alert('Pilih file Excel.'); return; }
        const file = fileInput.files[0];
        const kuisJudul = prompt("Masukkan Judul untuk kuis ini:", file.name.replace(/\.[^/.]+$/, ""));
        if (!kuisJudul) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                const questions = [];
                const answerMap = {'A': '0', 'B': '1', 'C': '2', 'D': '3'};
                for (const row of jsonData) {
                    const jawabanBenar = row.jawaban_benar?.toString().trim().toUpperCase();
                    if (!row.pertanyaan || !row.pilihan_a || !row.pilihan_b || !row.pilihan_c || !row.pilihan_d || !jawabanBenar || !answerMap.hasOwnProperty(jawabanBenar)) {
                        alert(`Data tidak valid pada baris: "${row.pertanyaan}". Impor dibatalkan.`); return;
                    }
                    questions.push({ questionText: String(row.pertanyaan), options: [String(row.pilihan_a), String(row.pilihan_b), String(row.pilihan_c), String(row.pilihan_d)], correctIndex: answerMap[jawabanBenar] });
                }
                if (questions.length === 0) { alert("Tidak ada pertanyaan valid ditemukan."); return; }
                const kuisData = { judul: kuisJudul, dosenId: currentUserData.uid, dosenNama: currentUserData.nama, questions: questions, createdAt: Timestamp.now() };
                await addDoc(collection(db, "kuis"), kuisData);
                alert(`Kuis "${kuisJudul}" berhasil diupload!`);
                fileInput.value = ''; loadKuisForDosen();
            } catch (error) { alert('Gagal memproses file: ' + error.message); }
        };
        reader.readAsArrayBuffer(file);
    });

    document.getElementById('downloadTemplateLink').addEventListener('click', (e) => {
        e.preventDefault();
        const templateData = [
            ["pertanyaan", "pilihan_a", "pilihan_b", "pilihan_c", "pilihan_d", "jawaban_benar"],
            ["Siapakah presiden pertama Indonesia?", "Joko Widodo", "Soekarno", "Soeharto", "B.J. Habibie", "B"],
            ["Apa ibukota dari negara Jepang?", "Kyoto", "Osaka", "Tokyo", "Nagoya", "C"]
        ];
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Template Soal Kuis");
        XLSX.writeFile(wb, "Template_Kuis_LMS.xlsx");
    });

    async function loadDosenKuisHistory() {
        const historyContainer = document.getElementById('dosenKuisHistoryList');
        historyContainer.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Memuat...</td></tr>';
        try {
            const kuisQuery = query(collection(db, "kuis"), where("dosenId", "==", currentUserData.uid));
            const kuisSnapshot = await getDocs(kuisQuery);
            if (kuisSnapshot.empty) { historyContainer.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada riwayat.</td></tr>'; return; }
            const kuisIds = kuisSnapshot.docs.map(doc => doc.id);
            if (kuisIds.length === 0) { historyContainer.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada riwayat.</td></tr>'; return; }
            const submissionsQuery = query(collection(db, "kuisSubmissions"), where("kuisId", "in", kuisIds), orderBy("timestamp", "desc"));
            const submissionsSnapshot = await getDocs(submissionsQuery);
            if (submissionsSnapshot.empty) { historyContainer.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada mahasiswa mengerjakan kuis Anda.</td></tr>'; return; }
            historyContainer.innerHTML = '';
            submissionsSnapshot.forEach(doc => {
                const sub = doc.data();
                const submissionDate = sub.timestamp.toDate().toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                historyContainer.innerHTML += `<tr><td>${sub.mahasiswaNama}</td><td>${sub.kuisJudul}</td><td><span class="badge bg-primary">${sub.skorPersen}%</span></td><td>${submissionDate}</td></tr>`;
            });
        } catch (error) {
            console.error("Error loading history: ", error);
            historyContainer.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Gagal memuat riwayat.</td></tr>';
        }
    }

    async function loadKuisForMahasiswa() {
        const kuisContainer = document.getElementById('kuisListMahasiswa');
        kuisContainer.innerHTML = '<p class="text-center text-muted">Memuat...</p>';
        const kuisQuery = query(collection(db, "kuis"), orderBy("createdAt", "desc"));
        const kuisSnapshot = await getDocs(kuisQuery);
        kuisContainer.innerHTML = '';
        if (kuisSnapshot.empty) kuisContainer.innerHTML = '<p class="text-center text-muted">Belum ada kuis.</p>';
        kuisSnapshot.forEach(doc => {
            const kuis = doc.data();
             kuisContainer.innerHTML += `<button type="button" class="list-group-item list-group-item-action list-group-item-light" onclick="startKuis('${doc.id}')"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 text-dark">${kuis.judul}</h6><span class="badge rounded-pill text-bg-primary">${kuis.questions.length} Soal</span></div><small class="text-muted"><i class="bi bi-person-fill"></i> Oleh: ${kuis.dosenNama}</small></button>`;
        });
    }
    
    async function loadMahasiswaKuisHistory() {
        const historyContainer = document.getElementById('mahasiswaKuisHistoryList');
        historyContainer.innerHTML = '<p class="text-center text-muted">Memuat riwayat...</p>';
        try {
            const q = query(collection(db, "kuisSubmissions"), where("mahasiswaId", "==", currentUserData.uid), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) { historyContainer.innerHTML = '<p class="text-center text-muted">Kamu belum mengerjakan kuis.</p>'; return; }
            historyContainer.innerHTML = '';
            querySnapshot.forEach(doc => {
                const sub = doc.data();
                const submissionDate = sub.timestamp.toDate().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                historyContainer.innerHTML += `<div class="list-group-item"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${sub.kuisJudul}</h6><span class="badge ${sub.skorPersen >= 75 ? 'bg-success' : 'bg-warning'} rounded-pill">${sub.skorPersen}%</span></div><small class="text-muted">Dikerjakan pada: ${submissionDate}</small></div>`;
            });
        } catch (error) {
            console.error("Error loading student history: ", error);
            historyContainer.innerHTML = '<p class="text-center text-danger">Gagal memuat riwayat.</p>';
        }
    }
    
    let currentKuisData = null;
    let currentKuisId = null;

    window.startKuis = async function(kuisId) {
        const docRef = doc(db, "kuis", kuisId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            currentKuisId = kuisId;
            currentKuisData = docSnap.data();
            document.getElementById('kuisTitle').innerText = currentKuisData.judul;
            const container = document.getElementById('kuisQuestionContainer');
            container.innerHTML = '';
            currentKuisData.questions.forEach((q, index) => {
                const optionsHTML = q.options.map((option, i) => `<div class="form-check fs-5 mb-2"><input class="form-check-input" type="radio" name="question-${index}" id="q-${index}-o-${i}" value="${i}"><label class="form-check-label" for="q-${index}-o-${i}"> ${option} </label></div>`).join('');
                container.innerHTML += `<div class="card mb-3"><div class="card-body p-4"><p class="card-text fw-bold fs-5">${index + 1}. ${q.questionText}</p><hr>${optionsHTML}</div></div>`;
            });
            showView('kuis-view');
        }
    }

    document.getElementById('submitKuisBtn').addEventListener('click', async (e) => {
        let score = 0, answeredQuestions = 0;
        const totalQuestions = currentKuisData.questions.length;
        currentKuisData.questions.forEach((q, index) => {
            const selected = document.querySelector(`input[name="question-${index}"]:checked`);
            if(selected) {
                answeredQuestions++;
                if (selected.value === q.correctIndex) score++;
            }
        });
        if (answeredQuestions < totalQuestions && !confirm('Anda belum menjawab semua. Yakin kumpulkan?')) return;
        
        const submitButton = e.target;
        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Memproses...`;
        const finalScore = Math.round((score / totalQuestions) * 100);
        
        const submissionData = {
            mahasiswaId: currentUserData.uid, mahasiswaNama: currentUserData.nama, kuisId: currentKuisId,
            kuisJudul: currentKuisData.judul, skorDapat: score, totalSoal: totalQuestions,
            skorPersen: finalScore, timestamp: Timestamp.now()
        };
        await addDoc(collection(db, "kuisSubmissions"), submissionData);
        
        const userDocRef = doc(db, "users", currentUserData.uid);
        await updateDoc(userDocRef, { totalSkor: increment(finalScore) });

        alert(`Kuis Selesai!\nJawaban Benar: ${score} dari ${totalQuestions}\nAnda mendapatkan ${finalScore} poin baru!`);
        currentUserData.totalSkor = (currentUserData.totalSkor || 0) + finalScore;
        document.getElementById('mahasiswaWelcome').innerHTML = `<i class="bi bi-gem"></i> Poin Kamu: <strong>${currentUserData.totalSkor}</strong>`;
        submitButton.disabled = false;
        submitButton.innerHTML = `<i class="bi bi-check2-circle"></i> Selesai & Kumpulkan Jawaban`;
        showView('mahasiswa-view');
        loadMahasiswaKuisHistory();
    });

</script>

</body>
</html>

