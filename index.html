<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS Gamifikasi Mahasiswa</title>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- SheetJS for Excel Upload -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #00684A; /* Poltekkes Green */
            --secondary-color: #00AAB5; /* Teal Accent */
            --light-bg: #f9fafb;
            --card-border-radius: 0.75rem;
            --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-bg);
            color: #333;
        }

        /* Sembunyikan semua view secara default */
        .view {
            display: none;
        }

        /* Custom Styles */
        .card {
            border: none;
            border-radius: var(--card-border-radius);
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 500;
        }
        .btn-primary:hover {
            background-color: #004d37;
            border-color: #004d37;
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            font-weight: 500;
        }
        .btn-success:hover {
            background-color: #008a94;
            border-color: #008a94;
        }

        .navbar-brand {
            font-weight: 600;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Login & Leaderboard Specific */
        #login-view .brand-logo {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        #leaderboardList .list-group-item {
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
        }
        #leaderboardList .list-group-item:nth-child(1) { border-left-color: #ffd700; } /* Gold */
        #leaderboardList .list-group-item:nth-child(2) { border-left-color: #c0c0c0; } /* Silver */
        #leaderboardList .list-group-item:nth-child(3) { border-left-color: #cd7f32; } /* Bronze */

        .leaderboard-badge { font-size: 1rem; }
        #leaderboardList li:nth-child(1) .leaderboard-badge { background-color: #ffd700 !important; color: #333; }
        #leaderboardList li:nth-child(2) .leaderboard-badge { background-color: #c0c0c0 !important; color: #333; }
        #leaderboardList li:nth-child(3) .leaderboard-badge { background-color: #cd7f32 !important; }


        /* Admin Dashboard Specific */
        .stat-card {
            display: flex;
            align-items: center;
            padding: 1.25rem;
        }
        .stat-card .icon-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-right: 1.25rem;
        }
        .stat-card .stat-text h3 {
            font-size: 2.2rem;
            margin-bottom: 0;
            color: #333;
        }
        .stat-card .stat-text p {
            margin-bottom: 0;
            color: #6c757d;
        }
        .icon-primary { background-color: rgba(0, 104, 74, 0.1); color: var(--primary-color); }
        .icon-success { background-color: rgba(0, 170, 181, 0.1); color: var(--secondary-color); }
        .icon-info { background-color: rgba(13, 202, 240, 0.1); color: #0dcaf0; }
        .icon-warning { background-color: rgba(255, 193, 7, 0.1); color: #ffc107; }

        /* Dosen & Mahasiswa List Items */
        .list-group-item-action:hover {
            background-color: #e9f5f3;
            border-left: 4px solid var(--primary-color);
            transform: translateX(5px);
        }
        .list-group-item {
             transition: all 0.2s ease;
             border-left: 4px solid transparent;
        }
        .excel-upload-box {
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            padding: 1.5rem;
            border-radius: var(--card-border-radius);
            text-align: center;
        }

        /* Kuis View */
        #kuis-view .card {
            background-color: #fff;
        }
        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

    </style>
</head>
<body>

<main class="container my-4 my-lg-5">

    <!-- =================================================================== -->
    <!-- VIEW 1: HALAMAN LOGIN & LEADERBOARD (HALAMAN UTAMA)                 -->
    <!-- =================================================================== -->
    <div id="login-view" class="view">
        <div class="text-center mb-5">
            <div class="brand-logo"><i class="bi bi-mortarboard-fill"></i></div>
            <h1 class="display-5">LMS Gamifikasi Poltekkes</h1>
            <p class="lead text-muted">Masuk untuk memulai petualangan belajar Anda!</p>
        </div>
        <div class="row justify-content-center g-4">
            <div class="col-lg-7">
                 <div class="card p-2">
                    <div class="card-body">
                        <h3 class="card-title text-center mb-4"><i class="bi bi-trophy-fill text-warning"></i> Papan Peringkat Teratas</h3>
                        <ol id="leaderboardList" class="list-group list-group-numbered">
                            <li class="list-group-item">Memuat data peringkat...</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-body p-4 p-lg-5">
                        <h2 class="card-title text-center mb-4">Login Pengguna</h2>
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control form-control-lg" id="email" placeholder="contoh@email.com" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control form-control-lg" id="password" placeholder="******" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg w-100 mt-3">
                                <i class="bi bi-box-arrow-in-right"></i> Login
                            </button>
                            <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- VIEW 2: DASHBOARD ADMIN                                             -->
    <!-- =================================================================== -->
    <div id="admin-view" class="view">
        <nav class="navbar navbar-expand-lg navbar-light bg-white rounded-3 mb-4 p-3 shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><i class="bi bi-shield-lock-fill"></i> Panel Admin</a>
                <button id="logoutButtonAdmin" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </nav>
        
        <h4><i class="bi bi-graph-up-arrow"></i> Ringkasan Sistem</h4>
        <div class="row mb-4 g-4">
            <div class="col-md-6 col-lg-3">
                <div class="card stat-card">
                    <div class="icon-circle icon-primary"><i class="bi bi-people-fill"></i></div>
                    <div class="stat-text">
                        <h3 id="totalMahasiswaStat">0</h3><p>Total Mahasiswa</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card stat-card">
                    <div class="icon-circle icon-success"><i class="bi bi-person-video3"></i></div>
                    <div class="stat-text">
                        <h3 id="totalDosenStat">0</h3><p>Total Dosen</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card stat-card">
                    <div class="icon-circle icon-info"><i class="bi bi-book-fill"></i></div>
                    <div class="stat-text">
                        <h3 id="totalMateriStat">0</h3><p>Total Materi</p>
                    </div>
                </div>
            </div>
             <div class="col-md-6 col-lg-3">
                <div class="card stat-card">
                    <div class="icon-circle icon-warning"><i class="bi bi-patch-question-fill"></i></div>
                    <div class="stat-text">
                        <h3 id="totalKuisStat">0</h3><p>Total Kuis</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="bi bi-person-gear"></i> Manajemen Pengguna</h5>
                        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#userModal" onclick="prepareUserModal('new')">
                            <i class="bi bi-plus-circle"></i> Tambah Pengguna Manual
                        </button>
                        
                        <!-- [BARU] User Import Section -->
                        <div class="excel-upload-box mb-3">
                            <p class="mb-2 fw-bold">Atau, import pengguna dari file Excel:</p>
                            <div class="input-group">
                                 <input type="file" class="form-control" id="userExcelFile" accept=".xlsx, .xls, .csv">
                                 <button class="btn btn-outline-success" type="button" id="importUsersBtn"><i class="bi bi-upload"></i> Import</button>
                            </div>
                             <small class="form-text text-muted mt-2 d-block">
                                Pastikan format sesuai. <a href="#" id="downloadUserTemplateLink" class="fw-bold">Download Template</a>.
                            </small>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr><th>Nama</th><th>Email</th><th>Role</th><th>NIM/NIDN</th><th>Aksi</th></tr>
                                </thead>
                                <tbody id="userTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                 <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-3"><i class="bi bi-activity"></i> Aktivitas Pengerjaan Kuis Terbaru</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead><tr><th>Mahasiswa</th><th>Kuis</th><th>Skor</th></tr></thead>
                                <tbody id="recentSubmissionsTable">
                                    <tr><td colspan="3">Memuat aktivitas...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- =================================================================== -->
    <!-- VIEW 3: DASHBOARD DOSEN                                             -->
    <!-- =================================================================== -->
    <div id="dosen-view" class="view">
        <nav class="navbar navbar-light bg-white rounded-3 mb-4 p-3 shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><i class="bi bi-person-workspace"></i> Panel Dosen</a>
                <span class="navbar-text text-muted me-auto ms-4" id="dosenWelcome"></span>
                <button id="logoutButtonDosen" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </nav>
        <div class="row g-4">
            <!-- Kolom Materi -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4"><i class="bi bi-journal-text"></i> Manajemen Materi</h4>
                        <button class="btn btn-success w-100 mb-3" data-bs-toggle="modal" data-bs-target="#materiModal">
                            <i class="bi bi-file-earmark-plus"></i> Tambah Materi Baru
                        </button>
                        <div id="materiListDosen" class="list-group"></div>
                    </div>
                </div>
            </div>
            <!-- Kolom Kuis -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4"><i class="bi bi-controller"></i> Manajemen Kuis</h4>
                        <button class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#kuisModal" onclick="prepareKuisModal()">
                           <i class="bi bi-pencil-square"></i> Buat Kuis Manual
                        </button>
                        <div class="excel-upload-box">
                            <p class="mb-2">Atau, upload soal dari file Excel:</p>
                            <div class="input-group">
                                 <input type="file" class="form-control" id="excelFile" accept=".xlsx, .xls">
                                 <button class="btn btn-outline-primary" type="button" id="uploadExcelBtn"><i class="bi bi-upload"></i> Upload</button>
                            </div>
                             <small class="form-text text-muted mt-2 d-block">
                                Pastikan format sesuai. <a href="#" id="downloadTemplateLink" class="fw-bold">Download Template</a>.
                            </small>
                        </div>
                        <hr>
                        <h6>Daftar Kuis Dibuat:</h6>
                        <div id="kuisListDosen" class="list-group mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- [BARU] Riwayat Pengerjaan Kuis -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4"><i class="bi bi-card-checklist"></i> Riwayat Pengerjaan Kuis oleh Mahasiswa</h4>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Nama Mahasiswa</th>
                                        <th>Judul Kuis</th>
                                        <th>Skor</th>
                                        <th>Tanggal</th>
                                    </tr>
                                </thead>
                                <tbody id="dosenKuisHistoryList">
                                    <tr><td colspan="4" class="text-center text-muted">Memuat riwayat...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- =================================================================== -->
    <!-- VIEW 4: DASHBOARD MAHASISWA                                         -->
    <!-- =================================================================== -->
    <div id="mahasiswa-view" class="view">
        <nav class="navbar navbar-light bg-white rounded-3 mb-4 p-3 shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><i class="bi bi-easel2-fill"></i> Dashboard Mahasiswa</a>
                 <span class="navbar-text text-primary me-auto ms-4" id="mahasiswaWelcome"></span>
                <button id="logoutButtonMahasiswa" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </nav>
         <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4">📚 Materi Perkuliahan</h4>
                        <div id="materiListMahasiswa" class="list-group"></div>
                    </div>
                </div>
            </div>
             <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4">🚀 Kuis & Tantangan</h4>
                        <div id="kuisListMahasiswa" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- [BARU] Riwayat Pengerjaan Kuis Mahasiswa -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4"><i class="bi bi-clock-history"></i> Riwayat Pengerjaan Kuis Kamu</h4>
                        <div id="mahasiswaKuisHistoryList" class="list-group">
                            <p class="text-center text-muted">Memuat riwayat...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- =================================================================== -->
    <!-- VIEW 5: HALAMAN MENGERJAKAN KUIS                                    -->
    <!-- =================================================================== -->
    <div id="kuis-view" class="view">
        <div class="card shadow-sm mb-4">
            <div class="card-body d-flex justify-content-between align-items-center p-3">
                 <button class="btn btn-outline-secondary" onclick="showView('mahasiswa-view')"><i class="bi bi-arrow-left"></i> Kembali</button>
                 <h3 id="kuisTitle" class="mb-0"></h3>
                 <span class="badge bg-primary p-2">Semangat!</span>
            </div>
        </div>
        <div id="kuisQuestionContainer"></div>
        <button class="btn btn-primary btn-lg w-100 mt-4" id="submitKuisBtn"><i class="bi bi-check2-circle"></i> Selesai & Kumpulkan Jawaban</button>
    </div>

</main> <!-- End .container -->


<!-- =================================================================== -->
<!-- MODALS (Jendela Pop-up)                                             -->
<!-- =================================================================== -->

<!-- Modal User (Admin) -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: var(--card-border-radius);">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Tambah Pengguna</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label class="form-label">Nama Lengkap</label>
                        <input type="text" class="form-control" id="userName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="userPassword" placeholder="Minimal 6 karakter">
                        <small class="form-text text-muted">Saat mengedit, kosongkan jika tidak ingin mengubah password.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">NIM / NIDN</label>
                        <input type="text" class="form-control" id="userNim" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="userRole">
                            <option value="mahasiswa">Mahasiswa</option>
                            <option value="dosen">Dosen</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100"><i class="bi bi-save"></i> Simpan</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Materi (Dosen) -->
<div class="modal fade" id="materiModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border-radius: var(--card-border-radius);">
            <div class="modal-header">
                <h5 class="modal-title">Tambah/Edit Materi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="materiForm">
                    <input type="hidden" id="materiId">
                    <div class="mb-3">
                        <label class="form-label">Judul Materi</label>
                        <input type="text" id="materiJudul" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Isi Materi</label>
                        <textarea id="materiIsi" class="form-control" rows="10" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Simpan Materi</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Kuis (Dosen) -->
<div class="modal fade" id="kuisModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="border-radius: var(--card-border-radius);">
            <div class="modal-header">
                <h5 class="modal-title">Buat Kuis Baru</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="kuisForm">
                    <input type="hidden" id="kuisId">
                    <div class="mb-3">
                        <label class="form-label">Judul Kuis</label>
                        <input type="text" id="kuisJudul" class="form-control" required>
                    </div>
                    <hr>
                    <div id="questionsContainer">
                        <!-- Pertanyaan akan ditambahkan di sini oleh JS -->
                    </div>
                    <button type="button" class="btn btn-outline-success mt-2" onclick="addQuestionField()">
                        <i class="bi bi-plus-lg"></i> Tambah Pertanyaan
                    </button>
                    <hr>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Simpan Kuis</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Baca Materi (Mahasiswa) -->
<div class="modal fade" id="bacaMateriModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content" style="border-radius: var(--card-border-radius);">
            <div class="modal-header">
                <h5 class="modal-title" id="bacaMateriJudul"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bacaMateriIsi" style="white-space: pre-wrap;"></div>
        </div>
    </div>
</div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
    // Import fungsi yang dibutuhkan dari Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        doc, 
        getDoc, 
        getDocs, 
        setDoc,
        addDoc,
        updateDoc,
        deleteDoc,
        query,
        where,
        orderBy,
        limit,
        increment,
        Timestamp
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ===================================================================
    // KONFIGURASI FIREBASE                                              
    // ===================================================================
    // TODO: GANTI DENGAN KONFIGURASI FIREBASE ANDA SENDIRI
    const firebaseConfig = {
      apiKey: "AIzaSyBRESh5Mbo15ttJzBeBokgB6qz4zSemHuw",
      authDomain: "lisa-levesquerez204.firebaseapp.com",
      databaseURL: "https://lisa-levesquerez204.firebaseio.com",
      projectId: "lisa-levesquerez204",
      storageBucket: "lisa-levesquerez204.firebasestorage.app",
      messagingSenderId: "320775541227",
      appId: "1:320775541227:web:041c60b324aee5044249ae"
    };

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===================================================================
    // GLOBAL VARIABLES & UTILITY FUNCTIONS                              
    // ===================================================================
    let currentUserData = null; // Menyimpan data user yang login (nama, role, dll)
    const allViews = document.querySelectorAll('.view');
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));
    const materiModal = new bootstrap.Modal(document.getElementById('materiModal'));
    const kuisModal = new bootstrap.Modal(document.getElementById('kuisModal'));
    const bacaMateriModal = new bootstrap.Modal(document.getElementById('bacaMateriModal'));

    // Fungsi untuk menampilkan view tertentu dan menyembunyikan yang lain
    function showView(viewId) {
        allViews.forEach(view => {
            view.style.display = 'none';
        });
        document.getElementById(viewId).style.display = 'block';
    }
    
    // ===================================================================
    // AUTHENTICATION & PAGE ROUTING LOGIC                               
    // ===================================================================
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User sedang login
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                currentUserData = { uid: user.uid, ...userDoc.data() };
                // Arahkan ke dashboard berdasarkan role
                switch (currentUserData.role) {
                    case 'admin':
                        showView('admin-view');
                        loadAdminDashboardStats(); // Panggil fungsi dashboard admin
                        loadUsers();
                        break;
                    case 'dosen':
                        showView('dosen-view');
                        document.getElementById('dosenWelcome').innerText = `Selamat datang, ${currentUserData.nama}`;
                        loadDosenContent();
                        break;
                    case 'mahasiswa':
                        showView('mahasiswa-view');
                        document.getElementById('mahasiswaWelcome').innerHTML = `<i class="bi bi-gem"></i> Poin Kamu: <strong>${currentUserData.totalSkor || 0}</strong>`;
                        loadMahasiswaContent();
                        break;
                    default:
                        showView('login-view');
                }
            } else {
                console.error("User document not found in Firestore for UID:", user.uid);
                await signOut(auth);
            }
        } else {
            // User tidak login
            currentUserData = null;
            showView('login-view');
            loadLeaderboard();
        }
    });

    // Handle Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const loginError = document.getElementById('loginError');
        const loginButton = e.target.querySelector('button[type="submit"]');
        loginButton.disabled = true;
        loginButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...`;

        try {
            await signInWithEmailAndPassword(auth, email, password);
            loginError.classList.add('d-none');
        } catch (error) {
            loginError.textContent = "Email atau password salah!";
            loginError.classList.remove('d-none');
        } finally {
            loginButton.disabled = false;
            loginButton.innerHTML = `<i class="bi bi-box-arrow-in-right"></i> Login`;
        }
    });

    // Handle Logout
    document.querySelectorAll('[id^="logoutButton"]').forEach(btn => {
        btn.addEventListener('click', () => signOut(auth));
    });


    // ===================================================================
    // LEADERBOARD LOGIC (ON LOGIN PAGE)                                 
    // ===================================================================
    async function loadLeaderboard() {
        const leaderboardList = document.getElementById('leaderboardList');
        try {
            const q = query(
                collection(db, "users"),
                where("role", "==", "mahasiswa"),
                orderBy("totalSkor", "desc"),
                limit(5) // Tampilkan 5 teratas
            );
            const querySnapshot = await getDocs(q);
            leaderboardList.innerHTML = '';
            if (querySnapshot.empty) {
                leaderboardList.innerHTML = '<li class="list-group-item text-muted">Belum ada data peringkat.</li>';
                return;
            }
            let rank = 1;
            querySnapshot.forEach(doc => {
                const user = doc.data();
                let medalIcon = '';
                if(rank === 1) medalIcon = '<i class="bi bi-trophy-fill text-warning me-2"></i>';
                else if (rank === 2) medalIcon = '<i class="bi bi-trophy-fill text-secondary me-2" style="color: #c0c0c0 !important;"></i>';
                else if (rank === 3) medalIcon = '<i class="bi bi-trophy-fill text-danger me-2" style="color: #cd7f32 !important;"></i>';

                leaderboardList.innerHTML += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            ${medalIcon}
                            <span class="fw-bold">${user.nama}</span>
                            <br>
                            <small class="text-muted ms-4">NIM: ${user.nim_nidn}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill leaderboard-badge">${user.totalSkor || 0} Poin</span>
                    </li>`;
                rank++;
            });
        } catch (error) {
            console.error("Error loading leaderboard: ", error);
            leaderboardList.innerHTML = '<li class="list-group-item text-danger">Gagal memuat data peringkat. Silakan coba lagi.</li>';
        }
    }


    // ===================================================================
    // ADMIN DASHBOARD LOGIC                                             
    // ===================================================================
    async function loadAdminDashboardStats() {
        // Get user counts
        const usersSnapshot = await getDocs(collection(db, "users"));
        let mahasiswaCount = 0;
        let dosenCount = 0;
        usersSnapshot.forEach(doc => {
            if (doc.data().role === 'mahasiswa') mahasiswaCount++;
            if (doc.data().role === 'dosen') dosenCount++;
        });
        document.getElementById('totalMahasiswaStat').innerText = mahasiswaCount;
        document.getElementById('totalDosenStat').innerText = dosenCount;

        // Get content counts
        const materiSnapshot = await getDocs(collection(db, "materi"));
        const kuisSnapshot = await getDocs(collection(db, "kuis"));
        document.getElementById('totalMateriStat').innerText = materiSnapshot.size;
        document.getElementById('totalKuisStat').innerText = kuisSnapshot.size;

        // Get recent submissions
        const submissionsTable = document.getElementById('recentSubmissionsTable');
        const submissionsQuery = query(collection(db, "kuisSubmissions"), orderBy("timestamp", "desc"), limit(5));
        const submissionsSnapshot = await getDocs(submissionsQuery);
        submissionsTable.innerHTML = '';
        if (submissionsSnapshot.empty) {
            submissionsTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Belum ada aktivitas.</td></tr>';
            return;
        }
        submissionsSnapshot.forEach(async(submissionDoc) => {
            const sub = submissionDoc.data();
            const userDoc = await getDoc(doc(db, "users", sub.mahasiswaId));
            const mahasiswaNama = userDoc.exists() ? userDoc.data().nama : "Mahasiswa Dihapus";
            submissionsTable.innerHTML += `
                <tr>
                    <td>${mahasiswaNama}</td>
                    <td>${sub.kuisJudul}</td>
                    <td><span class="badge bg-info">${sub.skorPersen}%</span></td>
                </tr>
            `;
        });
    }

    const userForm = document.getElementById('userForm');
    
    // [DIUBAH] Siapkan modal (kosongkan form untuk user baru, isi dengan data untuk edit)
    window.prepareUserModal = async function(mode, userId = null) {
        userForm.reset();
        const userModalLabel = document.getElementById('userModalLabel');
        const userEmailInput = document.getElementById('userEmail');
        const userPasswordInput = document.getElementById('userPassword');
        document.getElementById('userId').value = userId || '';

        if (mode === 'edit') {
            userModalLabel.innerText = 'Edit Pengguna';
            userEmailInput.disabled = true; // Email tidak bisa diubah karena terkait akun otentikasi
            userPasswordInput.required = false;
            userPasswordInput.placeholder = "Kosongkan jika tidak ingin mengubah";

            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    document.getElementById('userName').value = data.nama;
                    userEmailInput.value = data.email;
                    document.getElementById('userNim').value = data.nim_nidn;
                    document.getElementById('userRole').value = data.role;
                    userModal.show();
                } else {
                    alert('Data pengguna tidak ditemukan.');
                }
            } catch (error) {
                alert('Gagal memuat data pengguna: ' + error.message);
            }
        } else { // mode === 'new'
            userModalLabel.innerText = 'Tambah Pengguna Baru';
            userEmailInput.disabled = false;
            userPasswordInput.required = true;
            userPasswordInput.placeholder = "Minimal 6 karakter";
            // Modal akan ditampilkan oleh atribut data-bs-toggle pada tombol
        }
    }


    // [DIUBAH] Muat semua user ke tabel dengan tombol Edit dan Hapus
    async function loadUsers() {
        const userTableBody = document.getElementById('userTableBody');
        userTableBody.innerHTML = '<tr><td colspan="5" class="text-center">Memuat...</td></tr>';
        const q = query(collection(db, "users"), where("role", "!=", "admin"));
        const querySnapshot = await getDocs(q);
        userTableBody.innerHTML = '';
        querySnapshot.forEach((doc) => {
            const user = doc.data();
            userTableBody.innerHTML += `
                <tr>
                    <td><strong>${user.nama}</strong></td>
                    <td>${user.email}</td>
                    <td><span class="badge rounded-pill text-bg-${user.role === 'dosen' ? 'success' : 'info'}">${user.role}</span></td>
                    <td>${user.nim_nidn}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="prepareUserModal('edit', '${doc.id}')"><i class="bi bi-pencil-square"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${doc.id}', '${user.nama}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    }

    // [DIUBAH] Handle submit form user (tambah/edit)
    userForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = document.getElementById('userId').value;
        const password = document.getElementById('userPassword').value;
        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;

        const userData = {
            nama: document.getElementById('userName').value,
            email: document.getElementById('userEmail').value,
            nim_nidn: document.getElementById('userNim').value,
            role: document.getElementById('userRole').value,
        };
        
        try {
            if (userId) { // Mode EDIT
                const userRef = doc(db, "users", userId);
                await updateDoc(userRef, {
                    nama: userData.nama,
                    nim_nidn: userData.nim_nidn,
                    role: userData.role,
                });
                
                if (password) {
                    alert("Data pengguna (Nama, NIM/NIDN, Role) berhasil diperbarui.\n\nCATATAN: Perubahan password dari panel admin tidak dapat dilakukan karena alasan keamanan. Ini memerlukan Firebase Admin SDK di sisi server.");
                } else {
                    alert('Data pengguna berhasil diperbarui!');
                }

            } else { // Mode Tambah PENGGUNA BARU
                if (password.length < 6) {
                    throw new Error("Password minimal 6 karakter!");
                }
                const userCredential = await createUserWithEmailAndPassword(auth, userData.email, password);
                const userPayload = { ...userData };
                if (userPayload.role === 'mahasiswa') {
                    userPayload.totalSkor = 0;
                }
                await setDoc(doc(db, "users", userCredential.user.uid), userPayload);
                alert('Pengguna baru berhasil dibuat!');
            }
            userModal.hide();
            loadUsers();
            loadAdminDashboardStats();
        } catch (error) {
            alert('Gagal menyimpan pengguna: ' + error.message);
        } finally {
            submitButton.disabled = false;
        }
    });


    // Hapus User
    window.deleteUser = async function(userId, userName) {
        if (confirm(`Apakah Anda yakin ingin menghapus ${userName}? Aksi ini tidak dapat dibatalkan.`)) {
            try {
                await deleteDoc(doc(db, "users", userId));
                alert('Pengguna berhasil dihapus dari database. Anda perlu menghapus user dari Firebase Authentication secara manual jika diperlukan.');
                loadUsers();
                loadAdminDashboardStats();
            } catch (error) {
                alert('Gagal menghapus: ' + error.message);
            }
        }
    }

    // [BARU] Logika untuk Import Pengguna dari Excel
    document.getElementById('downloadUserTemplateLink').addEventListener('click', (e) => {
        e.preventDefault();
        const templateData = [
            ["nama", "email", "password", "nim_nidn", "role"],
            ["Budi Santoso", "budi.mhs@email.com", "password123", "2101001", "mahasiswa"],
            ["Citra Lestari", "citra.mhs@email.com", "password123", "2101002", "mahasiswa"],
            ["Dr. Ahmad Dahlan", "ahmad.dosen@email.com", "dosenaman", "9901001", "dosen"]
        ];
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Template Import Pengguna");
        XLSX.writeFile(wb, "Template_Import_Pengguna.xlsx");
    });

    document.getElementById('importUsersBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('userExcelFile');
        const file = fileInput.files[0];
        const btn = document.getElementById('importUsersBtn');

        if (!file) {
            alert('Silakan pilih file untuk diimport.');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Mengimpor...`;

        const reader = new FileReader();
        reader.onload = async (e) => {
            let successCount = 0;
            let failCount = 0;
            let errorMessages = [];
            
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const usersToImport = XLSX.utils.sheet_to_json(worksheet);

                for (const user of usersToImport) {
                    const email = user.email?.toString().trim();
                    const password = user.password?.toString();
                    const role = user.role?.toString().trim().toLowerCase();
                    const nama = user.nama?.toString().trim();
                    const nim_nidn = user.nim_nidn?.toString().trim();
                    
                    if (!nama || !email || !password || !nim_nidn || !role || password.length < 6 || !['mahasiswa', 'dosen'].includes(role)) {
                        failCount++;
                        errorMessages.push(`Baris untuk ${email || 'email kosong'} dilewati: data tidak valid atau tidak lengkap.`);
                        continue;
                    }

                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const userPayload = { nama, email, nim_nidn, role };
                        if (role === 'mahasiswa') userPayload.totalSkor = 0;
                        await setDoc(doc(db, "users", userCredential.user.uid), userPayload);
                        successCount++;
                    } catch (error) {
                        failCount++;
                        let msg = error.code === 'auth/email-already-in-use' ? 'email sudah terdaftar' : 'gagal membuat akun';
                        errorMessages.push(`Gagal impor ${email}: ${msg}`);
                    }
                }

                let summary = `Proses impor selesai.\n\nBerhasil: ${successCount} pengguna.\nGagal: ${failCount} pengguna.`;
                if (errorMessages.length > 0) {
                    summary += `\n\nDetail Kegagalan:\n- ${errorMessages.slice(0, 5).join('\n- ')}`;
                    if (errorMessages.length > 5) summary += `\n- ...dan lainnya.`;
                }
                alert(summary);

                loadUsers();
                loadAdminDashboardStats();
                fileInput.value = '';

            } catch (error) {
                alert('Gagal memproses file: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="bi bi-upload"></i> Import`;
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // ===================================================================
    // DOSEN DASHBOARD LOGIC                                             
    // ===================================================================
    async function loadDosenContent() {
        loadMateriForDosen();
        loadKuisForDosen();
        loadDosenKuisHistory();
    }
    
    // -- Materi Logic --
    document.getElementById('materiForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            judul: document.getElementById('materiJudul').value,
            isi: document.getElementById('materiIsi').value,
            dosenId: currentUserData.uid,
            dosenNama: currentUserData.nama,
            createdAt: Timestamp.now()
        };
        await addDoc(collection(db, "materi"), data);
        materiModal.hide();
        document.getElementById('materiForm').reset();
        loadMateriForDosen();
    });

    async function loadMateriForDosen() {
        const listContainer = document.getElementById('materiListDosen');
        listContainer.innerHTML = '<p class="text-center text-muted">Memuat materi...</p>';
        const q = query(collection(db, "materi"), where("dosenId", "==", currentUserData.uid), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        listContainer.innerHTML = '';
        if (snapshot.empty) {
            listContainer.innerHTML = '<p class="text-center text-muted">Anda belum menambahkan materi.</p>';
            return;
        }
        snapshot.forEach(doc => {
            const materi = doc.data();
            listContainer.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-file-earmark-text me-2"></i>${materi.judul}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMateri('${doc.id}')"><i class="bi bi-trash"></i></button>
                </div>
            `;
        });
    }
    
    window.deleteMateri = async function(id) {
        if (confirm('Yakin ingin hapus materi ini?')) {
            await deleteDoc(doc(db, "materi", id));
            loadMateriForDosen();
        }
    }
    
    // -- Kuis Logic --
    let questionCount = 0;
    
    window.addQuestionField = function() {
        questionCount++;
        const container = document.getElementById('questionsContainer');
        const questionDiv = document.createElement('div');
        questionDiv.className = 'card mb-3 bg-light';
        questionDiv.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <h6>Pertanyaan ${questionCount}</h6>
                    <button type="button" class="btn-close" onclick="this.closest('.card').remove()"></button>
                </div>
                <textarea class="form-control mb-2" placeholder="Tulis pertanyaan di sini" required></textarea>
                <div class="input-group mb-1"> <span class="input-group-text">A</span> <input type="text" class="form-control" placeholder="Pilihan A" required> </div>
                <div class="input-group mb-1"> <span class="input-group-text">B</span> <input type="text" class="form-control" placeholder="Pilihan B" required> </div>
                <div class="input-group mb-1"> <span class="input-group-text">C</span> <input type="text" class="form-control" placeholder="Pilihan C" required> </div>
                <div class="input-group mb-2"> <span class="input-group-text">D</span> <input type="text" class="form-control" placeholder="Pilihan D" required> </div>
                <select class="form-select form-select-sm" required>
                    <option value="" selected disabled>-- Pilih Jawaban Benar --</option> <option value="0">Jawaban A</option> <option value="1">Jawaban B</option> <option value="2">Jawaban C</option> <option value="3">Jawaban D</option>
                </select>
            </div>
        `;
        container.appendChild(questionDiv);
    }

    window.prepareKuisModal = function() {
        document.getElementById('kuisForm').reset();
        document.getElementById('questionsContainer').innerHTML = '';
        questionCount = 0;
        addQuestionField();
    }
    
    document.getElementById('kuisForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const questions = [];
        const questionElements = document.getElementById('questionsContainer').querySelectorAll('.card');

        questionElements.forEach(qEl => {
            const questionText = qEl.querySelector('textarea').value;
            const options = Array.from(qEl.querySelectorAll('input[type="text"]')).map(input => input.value);
            const correctIndex = qEl.querySelector('select').value;
            if(questionText && options.every(o => o) && correctIndex) {
                 questions.push({ questionText, options, correctIndex });
            }
        });
        
        if (questions.length === 0) {
            alert("Kuis harus memiliki setidaknya satu pertanyaan yang valid.");
            return;
        }

        const kuisData = {
            judul: document.getElementById('kuisJudul').value,
            dosenId: currentUserData.uid,
            dosenNama: currentUserData.nama,
            questions: questions,
            createdAt: Timestamp.now()
        };

        try {
            await addDoc(collection(db, "kuis"), kuisData);
            kuisModal.hide();
            loadKuisForDosen();
        } catch(error) {
            alert('Gagal menyimpan kuis: ' + error.message);
        }
    });
    
    async function loadKuisForDosen() {
        const listContainer = document.getElementById('kuisListDosen');
        listContainer.innerHTML = '<p class="text-center text-muted">Memuat kuis...</p>';
        const q = query(collection(db, "kuis"), where("dosenId", "==", currentUserData.uid), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        listContainer.innerHTML = '';
        if (snapshot.empty) {
            listContainer.innerHTML = '<p class="text-center text-muted">Anda belum membuat kuis.</p>';
            return;
        }
        snapshot.forEach(doc => {
            const kuis = doc.data();
            listContainer.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-patch-question me-2"></i> ${kuis.judul} (${kuis.questions.length} soal)</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteKuis('${doc.id}')"><i class="bi bi-trash"></i></button>
                </div>
            `;
        });
    }

    window.deleteKuis = async function(id) {
         if (confirm('Yakin ingin hapus kuis ini?')) {
            await deleteDoc(doc(db, "kuis", id));
            loadKuisForDosen();
        }
    }

    // -- Kuis Upload Excel Logic --
    document.getElementById('uploadExcelBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('excelFile');
        if (fileInput.files.length === 0) {
            alert('Silakan pilih file Excel terlebih dahulu.');
            return;
        }
        const file = fileInput.files[0];
        const kuisJudul = prompt("Masukkan Judul untuk kuis ini:", file.name.replace(/\.[^/.]+$/, ""));
        if (!kuisJudul) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                const questions = [];
                const answerMap = {'A': '0', 'B': '1', 'C': '2', 'D': '3'};

                for (const row of jsonData) {
                    const jawabanBenar = row.jawaban_benar?.toString().trim().toUpperCase();
                    if (!row.pertanyaan || !row.pilihan_a || !row.pilihan_b || !row.pilihan_c || !row.pilihan_d || !jawabanBenar) {
                        alert(`Data tidak lengkap pada baris dengan pertanyaan: "${row.pertanyaan}". Pastikan semua kolom terisi.`);
                        return;
                    }
                    if (!answerMap.hasOwnProperty(jawabanBenar)) {
                        alert(`Format jawaban benar salah pada pertanyaan: "${row.pertanyaan}". Gunakan huruf A, B, C, atau D.`);
                        return;
                    }
                    
                    questions.push({
                        questionText: String(row.pertanyaan),
                        options: [String(row.pilihan_a), String(row.pilihan_b), String(row.pilihan_c), String(row.pilihan_d)],
                        correctIndex: answerMap[jawabanBenar]
                    });
                }

                if (questions.length === 0) {
                    alert("Tidak ada pertanyaan valid yang ditemukan dalam file Excel.");
                    return;
                }

                const kuisData = {
                    judul: kuisJudul,
                    dosenId: currentUserData.uid,
                    dosenNama: currentUserData.nama,
                    questions: questions,
                    createdAt: Timestamp.now()
                };

                await addDoc(collection(db, "kuis"), kuisData);
                alert(`Kuis "${kuisJudul}" dengan ${questions.length} pertanyaan berhasil diupload!`);
                fileInput.value = ''; // Reset file input
                loadKuisForDosen();
            } catch (error) {
                alert('Gagal memproses file Excel: ' + error.message);
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // Download Template Excel
    document.getElementById('downloadTemplateLink').addEventListener('click', (e) => {
        e.preventDefault();
        const templateData = [
            ["pertanyaan", "pilihan_a", "pilihan_b", "pilihan_c", "pilihan_d", "jawaban_benar"],
            ["Siapakah presiden pertama Indonesia?", "Joko Widodo", "Soekarno", "Soeharto", "B.J. Habibie", "B"],
            ["Apa ibukota dari negara Jepang?", "Kyoto", "Osaka", "Tokyo", "Nagoya", "C"]
        ];
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Template Soal Kuis");
        XLSX.writeFile(wb, "Template_Kuis_LMS.xlsx");
    });

    // [BARU] Load Riwayat Kuis untuk Dosen
    async function loadDosenKuisHistory() {
        const historyContainer = document.getElementById('dosenKuisHistoryList');
        historyContainer.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Memuat riwayat...</td></tr>';

        try {
            // 1. Get all quizzes made by this lecturer
            const kuisQuery = query(collection(db, "kuis"), where("dosenId", "==", currentUserData.uid));
            const kuisSnapshot = await getDocs(kuisQuery);

            if (kuisSnapshot.empty) {
                historyContainer.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada kuis yang dibuat. Riwayat akan muncul di sini.</td></tr>';
                return;
            }

            const kuisIds = kuisSnapshot.docs.map(doc => doc.id);
            
            if (kuisIds.length === 0) {
                historyContainer.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada riwayat pengerjaan kuis.</td></tr>';
                return;
            }

            // 2. Get all submissions for those quizzes
            const submissionsQuery = query(
                collection(db, "kuisSubmissions"), 
                where("kuisId", "in", kuisIds),
                orderBy("timestamp", "desc")
            );
            const submissionsSnapshot = await getDocs(submissionsQuery);

            if (submissionsSnapshot.empty) {
                historyContainer.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Belum ada mahasiswa yang mengerjakan kuis Anda.</td></tr>';
                return;
            }
            
            historyContainer.innerHTML = '';
            submissionsSnapshot.forEach(doc => {
                const sub = doc.data();
                const submissionDate = sub.timestamp.toDate().toLocaleDateString('id-ID', {
                    day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                historyContainer.innerHTML += `
                    <tr>
                        <td>${sub.mahasiswaNama}</td>
                        <td>${sub.kuisJudul}</td>
                        <td><span class="badge bg-primary">${sub.skorPersen}%</span></td>
                        <td>${submissionDate}</td>
                    </tr>
                `;
            });

        } catch (error) {
            console.error("Error loading lecturer's quiz history: ", error);
            historyContainer.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Gagal memuat riwayat.</td></tr>';
        }
    }


    // ===================================================================
    // MAHASISWA DASHBOARD LOGIC                                         
    // ===================================================================
    async function loadMahasiswaContent() {
        loadMateriForMahasiswa();
        loadKuisForMahasiswa();
        loadMahasiswaKuisHistory();
    }

    async function loadMateriForMahasiswa() {
        const materiContainer = document.getElementById('materiListMahasiswa');
        materiContainer.innerHTML = '<p class="text-center text-muted">Memuat...</p>';
        const materiQuery = query(collection(db, "materi"), orderBy("createdAt", "desc"));
        const materiSnapshot = await getDocs(materiQuery);
        materiContainer.innerHTML = '';
        if (materiSnapshot.empty) materiContainer.innerHTML = '<p class="text-center text-muted">Belum ada materi yang tersedia.</p>';
        materiSnapshot.forEach(doc => {
            const materi = doc.data();
            materiContainer.innerHTML += `
                <button type="button" class="list-group-item list-group-item-action" onclick="bacaMateri('${doc.id}')">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 text-dark">${materi.judul}</h6>
                    </div>
                    <small class="text-muted"><i class="bi bi-person-fill"></i> Oleh: ${materi.dosenNama}</small>
                </button>
            `;
        });
    }

    async function loadKuisForMahasiswa() {
        const kuisContainer = document.getElementById('kuisListMahasiswa');
        kuisContainer.innerHTML = '<p class="text-center text-muted">Memuat...</p>';
        const kuisQuery = query(collection(db, "kuis"), orderBy("createdAt", "desc"));
        const kuisSnapshot = await getDocs(kuisQuery);
        kuisContainer.innerHTML = '';
        if (kuisSnapshot.empty) kuisContainer.innerHTML = '<p class="text-center text-muted">Belum ada kuis yang tersedia.</p>';
        kuisSnapshot.forEach(doc => {
            const kuis = doc.data();
             kuisContainer.innerHTML += `
                <button type="button" class="list-group-item list-group-item-action list-group-item-light" onclick="startKuis('${doc.id}')">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 text-dark">${kuis.judul}</h6>
                        <span class="badge rounded-pill text-bg-primary">${kuis.questions.length} Soal</span>
                    </div>
                    <small class="text-muted"><i class="bi bi-person-fill"></i> Oleh: ${kuis.dosenNama}</small>
                </button>
            `;
        });
    }
    
    // [BARU] Load Riwayat Kuis untuk Mahasiswa
    async function loadMahasiswaKuisHistory() {
        const historyContainer = document.getElementById('mahasiswaKuisHistoryList');
        historyContainer.innerHTML = '<p class="text-center text-muted">Memuat riwayat...</p>';

        try {
            const q = query(
                collection(db, "kuisSubmissions"),
                where("mahasiswaId", "==", currentUserData.uid),
                orderBy("timestamp", "desc")
            );
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                historyContainer.innerHTML = '<p class="text-center text-muted">Kamu belum mengerjakan kuis apapun.</p>';
                return;
            }

            historyContainer.innerHTML = '';
            querySnapshot.forEach(doc => {
                const sub = doc.data();
                const submissionDate = sub.timestamp.toDate().toLocaleDateString('id-ID', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
                
                historyContainer.innerHTML += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${sub.kuisJudul}</h6>
                            <span class="badge ${sub.skorPersen >= 75 ? 'bg-success' : 'bg-warning'} rounded-pill">${sub.skorPersen}%</span>
                        </div>
                        <small class="text-muted">Dikerjakan pada: ${submissionDate}</small>
                    </div>
                `;
            });

        } catch (error) {
            console.error("Error loading student's quiz history: ", error);
            historyContainer.innerHTML = '<p class="text-center text-danger">Gagal memuat riwayat pengerjaan.</p>';
        }
    }

    window.bacaMateri = async function(materiId) {
        const docRef = doc(db, "materi", materiId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const materi = docSnap.data();
            document.getElementById('bacaMateriJudul').innerText = materi.judul;
            document.getElementById('bacaMateriIsi').innerText = materi.isi;
            bacaMateriModal.show();
        }
    }
    
    let currentKuisData = null;
    let currentKuisId = null;

    window.startKuis = async function(kuisId) {
        const docRef = doc(db, "kuis", kuisId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            currentKuisId = kuisId;
            currentKuisData = docSnap.data();
            document.getElementById('kuisTitle').innerText = currentKuisData.judul;
            const container = document.getElementById('kuisQuestionContainer');
            container.innerHTML = '';
            
            currentKuisData.questions.forEach((q, index) => {
                const optionsHTML = q.options.map((option, i) => `
                    <div class="form-check fs-5 mb-2">
                        <input class="form-check-input" type="radio" name="question-${index}" id="q-${index}-o-${i}" value="${i}">
                        <label class="form-check-label" for="q-${index}-o-${i}"> ${option} </label>
                    </div>
                `).join('');

                container.innerHTML += `
                    <div class="card mb-3">
                        <div class="card-body p-4">
                            <p class="card-text fw-bold fs-5">${index + 1}. ${q.questionText}</p>
                            <hr>
                            ${optionsHTML}
                        </div>
                    </div>
                `;
            });

            showView('kuis-view');
        }
    }

    document.getElementById('submitKuisBtn').addEventListener('click', async (e) => {
        let score = 0;
        let answeredQuestions = 0;
        const totalQuestions = currentKuisData.questions.length;

        currentKuisData.questions.forEach((q, index) => {
            const selected = document.querySelector(`input[name="question-${index}"]:checked`);
            if(selected) {
                answeredQuestions++;
                if (selected.value === q.correctIndex) {
                    score++;
                }
            }
        });

        if (answeredQuestions < totalQuestions) {
            if (!confirm('Anda belum menjawab semua pertanyaan. Yakin ingin mengumpulkan?')) {
                return;
            }
        }
        
        const submitButton = e.target;
        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memproses...`;

        const finalScore = Math.round((score / totalQuestions) * 100);
        
        // Simpan hasil pengerjaan ke koleksi baru 'kuisSubmissions'
        const submissionData = {
            mahasiswaId: currentUserData.uid,
            mahasiswaNama: currentUserData.nama,
            kuisId: currentKuisId,
            kuisJudul: currentKuisData.judul,
            skorDapat: score,
            totalSoal: totalQuestions,
            skorPersen: finalScore,
            timestamp: Timestamp.now()
        };
        await addDoc(collection(db, "kuisSubmissions"), submissionData);
        
        // Update total skor mahasiswa di koleksi 'users'
        const userDocRef = doc(db, "users", currentUserData.uid);
        await updateDoc(userDocRef, {
            totalSkor: increment(finalScore)
        });

        alert(`Kuis Selesai!\n\nJawaban Benar: ${score} dari ${totalQuestions}\nAnda mendapatkan ${finalScore} poin baru!`);

        // Update skor di welcome message secara lokal
        currentUserData.totalSkor = (currentUserData.totalSkor || 0) + finalScore;
        document.getElementById('mahasiswaWelcome').innerHTML = `<i class="bi bi-gem"></i> Poin Kamu: <strong>${currentUserData.totalSkor}</strong>`;
        
        submitButton.disabled = false;
        submitButton.innerHTML = `<i class="bi bi-check2-circle"></i> Selesai & Kumpulkan Jawaban`;

        showView('mahasiswa-view');
        loadMahasiswaKuisHistory(); // Muat ulang riwayat setelah submit
    });

</script>

</body>
</html>
